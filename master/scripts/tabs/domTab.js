/* See license.txt for terms of usage */


define(["../domplate/domplate","../domplate/tabView","../core/lib","i18n!../nls/domTab","../domplate/toolbar","./search","./ObjectSearch","../core/dragdrop","../domplate/domTree","../core/cookies","../domplate/tableView","../core/trace","../json-query/JSONQuery"],function(e,t,r,s,a,o,n,l,i,c,h,u){function d(){this.toolbar=new a,this.toolbar.addButtons(this.getToolbarButtons()),this.tableView=!1}var p=e.domplate,b=e.DIV,m=e.INPUT,y=e.SPAN,g=e.TABLE,B=e.TBODY,v=e.TD,f=e.TR;return d.prototype=p(t.Tab.prototype,{id:"DOM",label:s.domTabLabel,separator:b({class:"separator"}),tabBodyTag:b({class:"tab$tab.id\\Body tabBody",_repObject:"$tab"},b({class:"domToolbar"}),b({class:"domContent"})),domBox:g({class:"domBox",cellpadding:0,cellspacing:0},B(f(v({class:"content"},b({class:"title"},"$title")),v({class:"splitter"}),v({class:"results"},b({class:"resultsDefaultContent"},s.searchResultsDefaultText))))),queryResultsViewType:b({class:"queryResultsViewType"},m({class:"type",type:"checkbox",onclick:"$onTableView"}),y({class:"label"},s.queryResultsTableView)),onUpdateBody:function(e,t){if(this.toolbar.render(r.$(t,"domToolbar")),!r.supportsSelectElementText){var a=r.getElementByClass(t,"searchBox"),o=r.getElementByClass(a,"searchInput");o.setAttribute("disabled","true"),o.setAttribute("title",s.searchDisabledForIE);r.getElementByClass(a,"arrow").setAttribute("disabled","true")}this.updateSearchResultsUI()},getToolbarButtons:function(){var e=[];return e.push({id:"search",tag:o.Box.tag,initialize:o.Box.initialize}),e},createSearchObject:function(e){var t=r.getElementsByClass(this._body,"domTable");t=r.cloneArray(t);var s=t.map(function(e){return e.repObject.input});return new n(e,s,!1,o.caseSensitiveCookieName)},getSearchOptions:function(){var e=[];return e.push({label:s.searchOptionJsonQuery,checked:c.getBooleanCookie("searchJsonQuery"),command:r.bindFixed(this.onOption,this,"searchJsonQuery")}),e},onOption:function(e){o.Box.onOption(e),this.updateSearchResultsUI()},updateSearchResultsUI:function(){for(var e=c.getBooleanCookie("searchJsonQuery"),t=r.getElementsByClass(this._body,"domBox"),a=0;a<t.length;a++){var o=t[a],n=r.getElementByClass(o,"results"),l=r.getElementByClass(o,"splitter");e?(r.setClass(n,"visible"),r.setClass(l,"visible")):(r.removeClass(n,"visible"),r.removeClass(l,"visible"))}var i=r.getElementByClass(this._body,"searchInput");if(i){var h=e?s.jsonQueryPlaceholder:s.searchPlaceholder;i.setAttribute("placeholder",h)}},onSearch:function(e,t){if(c.getBooleanCookie("searchJsonQuery"))return this.evalJsonQuery(e,t);if(e.length<3)return!0;if(this.currSearch&&this.currSearch.text!==e&&(this.currSearch=null),this.currSearch||(this.currSearch=this.createSearchObject(e)),this.currSearch.findNext(e)){for(var s=this.currSearch.stack[1].object,a=this.getDomTree(s),o=0;o<this.currSearch.stack.length;o++)a.expandRow(this.currSearch.stack[o].object);var n=this.currSearch.getCurrentMatch(),l=a.getRow(n.value);if(l){var i=l.querySelector(".memberValueCell .objectBox");this.currSearch.selectText(i.firstChild),r.scrollIntoCenterView(i)}return!0}return this.currSearch.matches.length>0&&(this.currSearch=this.createSearchObject(e)),!1},evalJsonQuery:function(e,t){if(13!==t)return!0;for(var s=r.getElementsByClass(this._body,"domBox"),a=0;a<s.length;a++){var o=s[a],n=r.getElementByClass(o,"domTable"),l=n.repObject.input,c=o.querySelector(".domBox .results");r.clearNode(c);try{var d=this.queryResultsViewType.append({},c);if(this.tableView){r.getElementByClass(d,"type").setAttribute("checked","true")}var p=JSONQuery(e,l);if(c.repObject=p,this.tableView)h.render(c,p);else{new i(p).append(c)}}catch(e){u.exception(e)}}return!0},onTableView:function(e){var t=r.fixEvent(e),s=t.target,a=r.getAncestorByClass(s,"tabBody"),o=$(s).prop("checked");a.repObject.tableView=o;var n=r.getAncestorByClass(s,"results"),l=n.repObject,c=r.getElementByClass(n,"domTable");c&&c.parentNode.removeChild(c);var u=r.getElementByClass(n,"dataTableSizer");if(u&&u.parentNode.removeChild(u),o)h.render(n,l);else{new i(l).append(n)}},append:function(e){for(var t=r.$(this._body,"domContent"),s=[],a=e.log.pages||[],o=0;o<a.length;o++)s.push(a[o].title);var n=this.domBox.append({title:s.join(", ")},t),c=r.getElementByClass(n,"content"),h=r.getElementByClass(n,"splitter");this.splitter=new l.Tracker(h,{onDragStart:r.bind(this.onDragStart,this),onDragOver:r.bind(this.onDragOver,this),onDrop:r.bind(this.onDrop,this)}),this.updateSearchResultsUI(),new i(e).append(c),this.separator.append({},t)},getDomTree:function(e){for(var t=r.getElementsByClass(this._body,"domTable"),s=0;s<t.length;s++){var a=t[s].repObject;if(a.input===e)return a}return null},highlightFile:function(e,t){var s=this.getDomTree(e);if(s){s.expandRow(e.log),s.expandRow(e.log.entries);var a=s.expandRow(t);a&&r.setClassTimed(a,"jumpHighlight");r.$(this._body,"domContent").scrollTop=a.offsetTop}},onDragStart:function(e){r.getBody(this._body.ownerDocument).setAttribute("vResizing","true");var t=r.getAncestorByClass(e.element,"domBox"),s=r.getElementByClass(t,"content");this.startWidth=s.clientWidth},onDragOver:function(e,t){var s=r.getAncestorByClass(t.element,"domBox"),a=r.getElementByClass(s,"content"),o=this.startWidth+e.x;a.style.width=o+"px"},onDrop:function(e){r.getBody(this._body.ownerDocument).removeAttribute("vResizing")}}),d});
//# sourceMappingURL=domTab.js.map