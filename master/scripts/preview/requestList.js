/* See license.txt for terms of usage */


define(["../domplate/domplate","../core/lib","i18n!../nls/requestList","./harModel","../core/cookies","./requestBody","../domplate/infoTip","../domplate/popupMenu","./EntryTimeInfoTip","./EntrySizeInfoTip"],function(e,t,s,n,i,a,l,r,o,c){function d(e){this.input=e,this.pageTimings=[],this.addPageTiming({name:"onContentLoad",classes:"netContentLoadBar",description:s.ContentLoad}),this.addPageTiming({name:"onLoad",classes:"netWindowLoadBar",description:s.WindowLoad}),l.addListener(this)}function m(e){this.files=[],this.pageTimings=[],this.addFile(e)}var p=e.domplate,u=e.DIV,h=e.FOR,f=e.SPAN,g=e.TABLE,C=e.TBODY,b=e.TD,T=e.TR;return d.columns=["index","url","status","type","domain","serverIPAddress","connection","size","uncompressedSize","timeline"],d.defaultColumns=["url","status","size","uncompressedSize","timeline"],d.getVisibleColumns=function(){var e=i.getCookie("previewCols");if(e)return e=e.replace(/\+/g," "),e=unescape(e),e.split(" ");if(!e){var s=document.getElementById("content");if(s&&(e=s.getAttribute("previewCols")))return e.split(" ")}return t.cloneArray(d.defaultColumns)},d.setVisibleColumns=function(e,t){e||(e=d.getVisibleColumns()),e.join&&(e=e.join(" "));var s=document.getElementById("content");s&&s.setAttribute("previewCols",e),t||i.setCookie("previewCols",e)},d.setVisibleColumns(),d.prototype=p({tableTag:g({class:"netTable",cellpadding:0,cellspacing:0,onclick:"$onClick",_repObject:"$requestList"},C(T({class:"netSizerRow"},b({class:"netIndexCol netCol"}),b({class:"netHrefCol netCol",width:"20%"}),b({class:"netStatusCol netCol",width:"7%"}),b({class:"netTypeCol netCol",width:"7%"}),b({class:"netDomainCol netCol",width:"7%"}),b({class:"netServerIPAddressCol netCol",width:"7%"}),b({class:"netConnectionCol netCol",width:"7%"}),b({class:"netSizeCol netCol",width:"7%"}),b({class:"netUncompressedSizeCol netCol",width:"7%"}),b({class:"netTimeCol netCol",width:"100%"}),b({class:"netOptionsCol netCol",width:"15px"})))),fileTag:h("file","$files",T({class:"netRow loaded",$isExpandable:"$file|isExpandable",$responseError:"$file|isError",$responseRedirect:"$file|isRedirect",$fromCache:"$file|isFromCache"},b({class:"netIndexCol netCol"},u({class:"netIndexLabel netLabel"},"$file|getIndex")),b({class:"netHrefCol netCol"},u({class:"netHrefLabel netLabel",style:"margin-left: $file|getIndent\\px"},"$file|getHref"),u({class:"netFullHrefLabel netHrefLabel netLabel",style:"margin-left: $file|getIndent\\px"},"$file|getFullHref")),b({class:"netStatusCol netCol"},u({class:"netStatusLabel netLabel",title:"$file|getStatus"},"$file|getStatus")),b({class:"netTypeCol netCol"},u({class:"netTypeLabel netLabel",title:"$file|getType"},"$file|getType")),b({class:"netDomainCol netCol",title:"$file|getDomain"},u({class:"netDomainLabel netLabel"},"$file|getDomain")),b({class:"netServerIPAddressCol netCol"},u({class:"netServerIPAddressLabel netLabel",title:"$file|getServerIPAddress"},"$file|getServerIPAddress")),b({class:"netConnectionCol netCol"},u({class:"netConnectionLabel netLabel",title:"$file|getConnection"},"$file|getConnection")),b({class:"netSizeCol netCol"},u({class:"netSizeLabel netLabel"},"$file|getCompressedSize")),b({class:"netUncompressedSizeCol netCol"},u({class:"netSizeLabel netLabel"},"$file|getUncompressedSize")),b({class:"netTimeCol netCol"},u({class:"netTimelineBar"},"&nbsp;",u({class:"netBlockingBar netBar"}),u({class:"netResolvingBar netBar"}),u({class:"netConnectingBar netBar"}),u({class:"netSendingBar netBar"}),u({class:"netWaitingBar netBar"}),u({class:"netReceivingBar netBar"},f({class:"netTimeLabel"},"$file|getElapsedTime")))),b({class:"netOptionsCol netCol"},u({class:"netOptionsLabel netLabel",onclick:"$onOpenOptions"})))),headTag:T({class:"netHeadRow"},b({class:"netHeadCol",colspan:9},u({class:"netHeadLabel"},"$doc.rootFile.href"))),netInfoTag:T({class:"netInfoRow"},b({class:"netInfoCol",colspan:9})),summaryTag:T({class:"netRow netSummaryRow"},b({class:"netIndexCol netCol"}),b({class:"netHrefCol netCol"},u({class:"netCountLabel netSummaryLabel"},"-")),b({class:"netStatusCol netCol"}),b({class:"netTypeCol netCol"}),b({class:"netDomainCol netCol"}),b({class:"netServerIPAddressCol netCol"}),b({class:"netConnectionCol netCol"}),b({class:"netTotalSizeCol netSizeCol netCol"},u({class:"netTotalSizeLabel netSummaryLabel"},"0KB")),b({class:"netTotalUncompressedSizeCol netUncompressedSizeCol netCol"},u({class:"netTotalUncompressedSizeLabel netSummaryLabel"},"0KB")),b({class:"netTotalTimeCol netTimeCol netCol"},u({class:"",style:"width: 100%"},u({class:"netCacheSizeLabel netSummaryLabel"},"(",f("0KB"),f(" "+s.summaryFromCache),")"),u({class:"netUncompressedSizeLabel netSummaryLabel"},"(",f("0KB"),f(" "+s.uncompressed),")"),u({class:"netTimeBar"},f({class:"netTotalTimeLabel netSummaryLabel"},"0ms")))),b({class:"netOptionsCol netCol"})),getIndex:function(e){return e.index+1},getIndent:function(e){return 0},isError:function(e){var t=Math.floor(e.response.status/100);return 4===t||5===t||0===t},isRedirect:function(e){return!1},isFromCache:function(e){return e.cache&&e.cache.afterRequest||n.isCachedEntry(e)},getHref:function(e){var s=t.getFileName(this.getFullHref(e));return unescape(e.request.method+" "+s)},getFullHref:function(e){return unescape(e.request.url)},getStatus:function(e){return 0===e.response.status&&e.response._error?e.response._error:(e.response.status>0?e.response.status+" ":"")+e.response.statusText},getType:function(e){return e.response.content.mimeType},getDomain:function(e){return t.getPrettyDomain(e.request.url)},getServerIPAddress:function(e){return e.serverIPAddress||""},getConnection:function(e){return e.connection||""},getUncompressedSize:function(e){var t=n.getEntryUncompressedSize(e);return this.formatSize(t)},getCompressedSize:function(e){var t=n.getEntryTransferredSize(e);return this.formatSize(t)},isExpandable:function(e){return a.canShowFile(e)},formatSize:function(e){return t.formatSize(e)},getElapsedTime:function(e){var s=Math.round(10*e.time)/10;return t.formatTime(s.toFixed(2))},onClick:function(e){var s=t.fixEvent(e);if(t.isLeftClick(e)){var n=t.getAncestorByClass(s.target,"netRow");n&&(this.toggleHeadersRow(n),t.cancelEvent(e))}else t.isControlClick(e)&&window.open(e.target.innerText||e.target.textContent)},toggleHeadersRow:function(e){if(t.hasClass(e,"isExpandable")){var s,n=e.repObject;if(t.toggleClass(e,"opened"),t.hasClass(e,"opened")){s=this.netInfoTag.insertRows({},e)[0],s.repObject=n;(new a).render(s.firstChild,n)}else s=e.nextSibling,e.parentNode.removeChild(s)}},onOpenOptions:function(e){var s=t.fixEvent(e);if(t.cancelEvent(e),t.isLeftClick(e)){var n=s.target,i=t.getAncestorByClass(n,"netRow"),a=this.getMenuItems(i);if(a.length){new r({id:"requestContextMenu",items:a}).showPopup(n)}}},getMenuItems:function(e){var n=e.repObject,i=e.phase,a=i.files[0]===n&&this.phases[0]===i,l=[{label:s.menuBreakTimeline,type:"checkbox",disabled:a,checked:i.files[0]===n&&!a,command:t.bind(this.breakLayout,this,e)},"-",{label:s.menuOpenRequest,command:t.bind(this.openRequest,this,n)},{label:s.menuOpenResponse,disabled:!n.response.content.text,command:t.bind(this.openResponse,this,n)}];return t.dispatch(this.listeners,"getMenuItems",[l,this.input,n]),l},openRequest:function(e,t){window.open(e.request.url)},openResponse:function(e,t){var s=e.response.content.text,n=e.response.content.mimeType,i=e.response.content.encoding,a="data:"+(n||"")+";"+(i||"")+","+s;window.open(a)},breakLayout:function(e,s){var i=e.repObject,a=e.phase,l=a.files[0]===i;e.breakLayout=!l,e.setAttribute("breakLayout",e.breakLayout?"true":"false");var r=t.getAncestorByClass(e,"netTable"),o=n.getParentPage(this.input,i);this.updateLayout(r,o)},updateLayout:function(e,s){var a=n.getPageEntries(this.input,s);this.table=e;var l=this.table.firstChild,r=this.firstRow=l.firstChild.nextSibling;this.phases=[];var o=i.getCookie("phaseInterval");o||(o=4e3);var c=null,d=s?t.parseISO8601(s.startedDateTime):null,m=s&&s.pageTimings?s.pageTimings.onLoad:-1;m>0&&(m+=d);for(var p=0;p<a.length;p++){var u=a[p];t.hasClass(r,"netInfoRow")&&(r=r.nextSibling),r.repObject=u,d||(d=t.parseISO8601(u.startedDateTime));var h=t.parseISO8601(u.startedDateTime),f=c?t.parseISO8601(c.getLastStartTime()):0,g=c?c.endTime:0,C=!1;o>=0&&(C=h>m&&h-f>=o&&h+u.time>=g+o),"boolean"==typeof r.breakLayout?!c||r.breakLayout?c=this.startPhase(u):c.addFile(u):!c||C?c=this.startPhase(u):c.addFile(u),this.phases[0]!==c&&r.setAttribute("breakLayout",c.files[0]===u?"true":"false"),("number"!=typeof c.startTime||c.startTime>h)&&(c.startTime=h),("number"!=typeof c.endTime||c.endTime<h+u.time)&&(c.endTime=h+u.time),r=r.nextSibling}this.updateTimeStamps(s),this.updateTimeline(s),this.updateSummaries(s)},startPhase:function(e){var t=new m(e);return this.phases.push(t),t},calculateFileTimes:function(e,s,n){if(n!==s.phase&&(n=s.phase,this.phaseStartTime=n.startTime,this.phaseEndTime=n.endTime,this.phaseElapsed=this.phaseEndTime-n.startTime),!s.timings)return n;var i=s.timings.blocked<0?0:s.timings.blocked,a=i+(s.timings.dns<0?0:s.timings.dns),l=a+(s.timings.connect<0?0:s.timings.connect),r=l+(s.timings.send<0?0:s.timings.send),o=r+(s.timings.wait<0?0:s.timings.wait),c=o+(s.timings.receive<0?0:s.timings.receive),d=t.parseISO8601(s.startedDateTime);return this.barOffset=((d-this.phaseStartTime)/this.phaseElapsed*100).toFixed(3),this.barBlockingWidth=(i/this.phaseElapsed*100).toFixed(3),this.barResolvingWidth=(a/this.phaseElapsed*100).toFixed(3),this.barConnectingWidth=(l/this.phaseElapsed*100).toFixed(3),this.barSendingWidth=(r/this.phaseElapsed*100).toFixed(3),this.barWaitingWidth=(o/this.phaseElapsed*100).toFixed(3),this.barReceivingWidth=(c/this.phaseElapsed*100).toFixed(3),this.calculatePageTimings(e,s,n),n},calculatePageTimings:function(e,s,n){if(e)for(var i=t.parseISO8601(e.startedDateTime),a=0;a<n.pageTimings.length;a++){var l=n.pageTimings[a].time;if(l>0){var r=i+l-n.startTime,o=(r/this.phaseElapsed*100).toFixed(3);n.pageTimings[a].offset=o}}},updateTimeline:function(e){for(var s,n=this.firstRow;n;n=n.nextSibling){var i=n.repObject;if(i&&!t.hasClass(n,"netInfoRow")){s=this.calculateFileTimes(e,i,s),n.phase=i.phase,delete i.phase;var a=t.getElementByClass(n,"netTimelineBar"),l=a.children[0],r=l.nextSibling,o=r.nextSibling,c=o.nextSibling,d=c.nextSibling,m=d.nextSibling;l.style.left=o.style.left=r.style.left=c.style.left=d.style.left=m.style.left=this.barOffset+"%",l.style.width=this.barBlockingWidth+"%",r.style.width=this.barResolvingWidth+"%",o.style.width=this.barConnectingWidth+"%",c.style.width=this.barSendingWidth+"%",d.style.width=this.barWaitingWidth+"%",m.style.width=this.barReceivingWidth+"%";for(var p=t.getElementsByClass(a,"netPageTimingBar"),u=0;u<p.length;u++)p[u].parentNode.removeChild(p[u]);for(var h=0;h<s.pageTimings.length;h++){var f=s.pageTimings[h];if(f.offset){var g=a.ownerDocument.createElement("DIV");a.appendChild(g),f.classes&&t.setClass(g,f.classes),t.setClass(g,"netPageTimingBar netBar"),g.style.left=f.offset+"%",g.style.display="block",f.offset=null}}}}},updateTimeStamps:function(e){if(e){var s,n=[],i=this.pageTimings;e.pageTimings&&Object.keys(e.pageTimings).forEach(function(t){var s=e.pageTimings[t];if("number"==typeof s){for(var a={label:t,time:s,classes:"",comment:t},l=0;l<i.length;l++)if(i[l].name===t){a.classes=i[l].classes,a.comment=i[l].comment;break}n.push(a)}});var a=e.pageTimings?e.pageTimings._timeStamps:[];a&&n.push.apply(n,a);var l=this.phases;for(s=0;s<l.length;s++)for(var r=l[s],o=l[s+1],c=0;c<n.length;c++){var d=n[c],m=d.time;if(m){var p=t.parseISO8601(e.startedDateTime);m+=p,(!o||m<o.startTime)&&(0===s||m>=r.startTime)&&(r.startTime>m&&(r.startTime=m),r.endTime<m&&(r.endTime=m),r.pageTimings.push({classes:d.classes?d.classes:"netTimeStampBar",name:d.label,description:d.comment,time:d.time}))}}}},updateSummaries:function(e){for(var s=this.phases,n=0,i=0,a=0,l=0,r=0,o=0;o<s.length;++o){var c=s[o];c.invalidPhase=!1;var d=this.summarizePhase(c);n+=d.fileCount,i+=d.totalTransferredSize,a+=d.totalUncompressedSize,l+=d.cachedSize,r+=d.totalTime}var m=this.summaryRow;if(m){t.getElementByClass(m,"netCountLabel").firstChild.nodeValue=this.formatRequestCount(n);var p=t.getElementByClass(m,"netTotalSizeLabel");p.setAttribute("totalSize",i),p.firstChild.nodeValue=t.formatSize(i);var u=t.getElementByClass(m,"netTotalUncompressedSizeLabel");u.setAttribute("totalUncompressedSize",a),u.firstChild.nodeValue=t.formatSize(a);var h=t.getElementByClass(m,"netUncompressedSizeLabel");h.setAttribute("collapsed",0===a);h.childNodes[1].firstChild.nodeValue=t.formatSize(a);var f=t.getElementByClass(m,"netCacheSizeLabel");f.setAttribute("collapsed",0===l),f.childNodes[1].firstChild.nodeValue=t.formatSize(l);var g=t.getElementByClass(m,"netTotalTimeLabel"),C=t.formatTime(r.toFixed(2));e&&e.pageTimings.onLoad>0&&(C+=" (onload: "+t.formatTime(e.pageTimings.onLoad.toFixed(2))+")"),g.innerHTML=C}},formatRequestCount:function(e){return e+" "+(1===e?s.request:s.requests)},summarizePhase:function(e){for(var s=0,i=0,a=0,l=0,r=0,o=0,c=0;c<e.files.length;c++){var d=e.files[c],m=t.parseISO8601(d.startedDateTime);++l;var p=n.getEntryTransferredSize(d),u=n.getEntryUncompressedSize(d);i+=p,a+=u,n.isCachedEntry(d)&&(s+=u),(!r||m<r)&&(r=m);var h=m+d.time;h>o&&(o=h)}return{cachedSize:s,totalUncompressedSize:a,totalTransferredSize:i,totalTime:o-r,fileCount:l}},showInfoTip:function(e,s,n,i){var a=t.getAncestorByClass(s,"netTable");if(a&&a.repObject===this){var l=t.getAncestorByClass(s,"netRow");if(l){var r;if(t.getAncestorByClass(s,"netBar"))return e.setAttribute("multiline",!0),r=l.repObject.startedDateTime+"-nettime",this.infoTipURL=r,this.populateTimeInfoTip(e,l);if(t.hasClass(s,"netSizeLabel"))return r=l.repObject.startedDateTime+"-netsize",this.infoTipURL=r,this.populateSizeInfoTip(e,l)}}},populateTimeInfoTip:function(e,t){return o.render(this,t,e),!0},populateSizeInfoTip:function(e,t){return c.render(this,t,e),!0},render:function(e,t){var s=n.getPageEntries(this.input,t);return s.length?this.append(e,t,s):null},append:function(e,s,n){this.table||(this.table=this.tableTag.replace({requestList:this},e,this)),this.summaryRow||(this.summaryRow=this.summaryTag.insertRows({},this.table.firstChild)[0]);var i=this.table.firstChild,a=i.lastChild.previousSibling,l=n.map(function(e,s){return t.extend(e,{index:s})}),r=this.fileTag.insertRows({files:l},a,this);return this.updateLayout(this.table,s),r[0]},addPageTiming:function(e){this.pageTimings.push(e)}}),m.prototype={addFile:function(e){this.files.push(e),e.phase=this},getLastStartTime:function(){return this.files[this.files.length-1].startedDateTime}},d});
//# sourceMappingURL=requestList.js.map