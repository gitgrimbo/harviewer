/* See license.txt for terms of usage */

define(["../domplate/domplate","../core/lib","i18n!../nls/requestList","./harModel","../core/cookies","./requestBody","../domplate/infoTip","../domplate/popupMenu"],function(e,t,s,i,n,a,r,l){function o(e){this.input=e,this.pageTimings=[],this.addPageTiming({name:"onContentLoad",classes:"netContentLoadBar",description:s.ContentLoad}),this.addPageTiming({name:"onLoad",classes:"netWindowLoadBar",description:s.WindowLoad}),r.addListener(this)}function c(e){this.files=[],this.pageTimings=[],this.addFile(e)}var m=e.domplate,d=e.DIV,p=e.FOR,u=e.SPAN,f=e.TABLE,g=e.TBODY,h=e.TD,T=e.TR,C=m({tableTag:f({class:"timeInfoTip"},g()),timingsTag:p("time","$timings",T({class:"timeInfoTipRow",$collapsed:"$time|hideBar"},h({class:"$time|getBarClass timeInfoTipBar",$loaded:"$time.loaded",$fromCache:"$time.fromCache"}),h({class:"timeInfoTipCell startTime"},"$time.start|formatStartTime"),h({class:"timeInfoTipCell elapsedTime"},"$time.elapsed|formatTime"),h("$time|getLabel"))),startTimeTag:T(h(),h("$startTime.time|formatStartTime"),h({class:"timeInfoTipStartLabel",colspan:2},"$startTime|getLabel")),separatorTag:T({},h({class:"timeInfoTipSeparator",colspan:4,height:"10px"},u("$label"))),eventsTag:p("event","$events",T({class:"timeInfoTipEventRow"},h({class:"timeInfoTipBar",align:"center"},d({class:"$event|getPageTimingClass timeInfoTipEventBar"})),h("$event.start|formatStartTime"),h({colspan:2},"$event|getTimingLabel"))),hideBar:function(e){return!e.elapsed&&"request.phase.Blocking"===e.bar},getBarClass:function(e){return"net"+e.bar.substr(e.bar.lastIndexOf(".")+1)+"Bar"},getPageTimingClass:function(e){return e.classes?e.classes:""},formatTime:function(e){return t.formatTime(e.toFixed(2))},formatStartTime:function(e){var s=e>0,i=t.formatTime(Math.abs(e.toFixed(2)));return e?(s>0?"+":"-")+i:i},getLabel:function(e){return s[e.bar]},getTimingLabel:function(e){return e.bar},render:function(e,n,a){var r=e.input,l=n.repObject,o=i.getParentPage(r,l),c=o?t.parseISO8601(o.startedDateTime):null,m=t.parseISO8601(l.startedDateTime),d=C.tableTag.replace({},a),p={};p.time=c?m-c:m-n.phase.startTime,p.bar="request.Started",this.startTimeTag.insertRows({startTime:p},d.firstChild),this.separatorTag.insertRows({label:s["request.phases.label"]},d.firstChild);var u=0,f=[],g=l.timings.blocked,h=l.timings.dns,T=(l.timings.ssl,l.timings.connect),b=l.timings.send,S=l.timings.wait,v=l.timings.receive;if(g>=0&&f.push({bar:"request.phase.Blocking",elapsed:g,start:u}),h>=0&&f.push({bar:"request.phase.Resolving",elapsed:h,start:u+=g<0?0:g}),T>=0&&f.push({bar:"request.phase.Connecting",elapsed:T,start:u+=h<0?0:h}),b>=0&&f.push({bar:"request.phase.Sending",elapsed:b,start:u+=T<0?0:T}),S>=0&&f.push({bar:"request.phase.Waiting",elapsed:S,start:u+=b<0?0:b}),v>=0&&f.push({bar:"request.phase.Receiving",elapsed:v,start:u+=S<0?0:S,loaded:l.loaded,fromCache:i.isCachedEntry(l)}),this.timingsTag.insertRows({timings:f},d.firstChild),!o)return!0;for(var y=[],L=0;L<n.phase.pageTimings.length;L++){var z=n.phase.pageTimings[L];y.push({bar:z.description?z.description:z.name,start:c+z.time-m,classes:z.classes,time:z.time})}return y.length&&(y.sort(function(e,t){return e.time<t.time?-1:1}),this.separatorTag.insertRows({label:s["request.timings.label"]},d.firstChild),this.eventsTag.insertRows({events:y},d.firstChild)),!0}}),b=m({tag:d(d({class:"sizeInfoTip"},"$file|getSize"),d({class:"sizeInfoTip",style:"display: $file|getCachedDisplayStyle"},"$file|getCached")),zippedTag:d(d({class:"sizeInfoTip"},"$file|getBodySize"),d({class:"sizeInfoTip"},"$file|getContentSize"),d({class:"sizeInfoTip",style:"display: $file|getCachedDisplayStyle"},"$file|getCached")),getSize:function(e){var n=i.getEntryTransferredSize(e);return n<0?s.unknownSize:t.formatString(s.tooltipSize,t.formatSize(n),t.formatNumber(n))},getBodySize:function(e){var n=i.getEntryTransferredSize(e);return n<0?s.unknownSize:t.formatString(s.tooltipZippedSize,t.formatSize(n),t.formatNumber(n))},getContentSize:function(e){var n=i.getEntryUncompressedSize(e);return n<0?s.unknownSize:t.formatString(s.tooltipUnzippedSize,t.formatSize(n),t.formatNumber(n))},getCached:function(e){return i.isCachedEntry(e)?s.resourceFromCache:""},getCachedDisplayStyle:function(e){return i.isCachedEntry(e)?"block":"none"},render:function(e,t,s){var n=t.repObject;return i.getEntryUncompressedSize(n)===i.getEntryTransferredSize(n)?this.tag.replace({file:n},s):this.zippedTag.replace({file:n},s)}});return o.columns=["index","url","status","type","domain","serverIPAddress","connection","size","uncompressedSize","timeline"],o.defaultColumns=["url","status","size","uncompressedSize","timeline"],o.getVisibleColumns=function(){var e=n.getCookie("previewCols");if(e)return e=e.replace(/\+/g," "),e=unescape(e),e.split(" ");if(!e){var s=document.getElementById("content");if(s&&(e=s.getAttribute("previewCols")))return e.split(" ")}return t.cloneArray(o.defaultColumns)},o.setVisibleColumns=function(e,t){e||(e=o.getVisibleColumns()),e.join&&(e=e.join(" "));var s=document.getElementById("content");s&&s.setAttribute("previewCols",e),t||n.setCookie("previewCols",e)},o.setVisibleColumns(),o.prototype=m({tableTag:f({class:"netTable",cellpadding:0,cellspacing:0,onclick:"$onClick",_repObject:"$requestList"},g(T({class:"netSizerRow"},h({class:"netIndexCol netCol"}),h({class:"netHrefCol netCol",width:"20%"}),h({class:"netStatusCol netCol",width:"7%"}),h({class:"netTypeCol netCol",width:"7%"}),h({class:"netDomainCol netCol",width:"7%"}),h({class:"netServerIPAddressCol netCol",width:"7%"}),h({class:"netConnectionCol netCol",width:"7%"}),h({class:"netSizeCol netCol",width:"7%"}),h({class:"netUncompressedSizeCol netCol",width:"7%"}),h({class:"netTimeCol netCol",width:"100%"}),h({class:"netOptionsCol netCol",width:"15px"})))),fileTag:p("file","$files",T({class:"netRow loaded",$isExpandable:"$file|isExpandable",$responseError:"$file|isError",$responseRedirect:"$file|isRedirect",$fromCache:"$file|isFromCache"},h({class:"netIndexCol netCol"},d({class:"netIndexLabel netLabel"},"$file|getIndex")),h({class:"netHrefCol netCol"},d({class:"netHrefLabel netLabel",style:"margin-left: $file|getIndent\\px"},"$file|getHref"),d({class:"netFullHrefLabel netHrefLabel netLabel",style:"margin-left: $file|getIndent\\px"},"$file|getFullHref")),h({class:"netStatusCol netCol"},d({class:"netStatusLabel netLabel",title:"$file|getStatus"},"$file|getStatus")),h({class:"netTypeCol netCol"},d({class:"netTypeLabel netLabel",title:"$file|getType"},"$file|getType")),h({class:"netDomainCol netCol",title:"$file|getDomain"},d({class:"netDomainLabel netLabel"},"$file|getDomain")),h({class:"netServerIPAddressCol netCol"},d({class:"netServerIPAddressLabel netLabel",title:"$file|getServerIPAddress"},"$file|getServerIPAddress")),h({class:"netConnectionCol netCol"},d({class:"netConnectionLabel netLabel",title:"$file|getConnection"},"$file|getConnection")),h({class:"netSizeCol netCol"},d({class:"netSizeLabel netLabel"},"$file|getCompressedSize")),h({class:"netUncompressedSizeCol netCol"},d({class:"netSizeLabel netLabel"},"$file|getUncompressedSize")),h({class:"netTimeCol netCol"},d({class:"netTimelineBar"},"&nbsp;",d({class:"netBlockingBar netBar"}),d({class:"netResolvingBar netBar"}),d({class:"netConnectingBar netBar"}),d({class:"netSendingBar netBar"}),d({class:"netWaitingBar netBar"}),d({class:"netReceivingBar netBar"},u({class:"netTimeLabel"},"$file|getElapsedTime")))),h({class:"netOptionsCol netCol"},d({class:"netOptionsLabel netLabel",onclick:"$onOpenOptions"})))),headTag:T({class:"netHeadRow"},h({class:"netHeadCol",colspan:9},d({class:"netHeadLabel"},"$doc.rootFile.href"))),netInfoTag:T({class:"netInfoRow"},h({class:"netInfoCol",colspan:9})),summaryTag:T({class:"netRow netSummaryRow"},h({class:"netIndexCol netCol"}),h({class:"netHrefCol netCol"},d({class:"netCountLabel netSummaryLabel"},"-")),h({class:"netStatusCol netCol"}),h({class:"netTypeCol netCol"}),h({class:"netDomainCol netCol"}),h({class:"netServerIPAddressCol netCol"}),h({class:"netConnectionCol netCol"}),h({class:"netTotalSizeCol netSizeCol netCol"},d({class:"netTotalSizeLabel netSummaryLabel"},"0KB")),h({class:"netTotalUncompressedSizeCol netUncompressedSizeCol netCol"},d({class:"netTotalUncompressedSizeLabel netSummaryLabel"},"0KB")),h({class:"netTotalTimeCol netTimeCol netCol"},d({class:"",style:"width: 100%"},d({class:"netCacheSizeLabel netSummaryLabel"},"(",u("0KB"),u(" "+s.summaryFromCache),")"),d({class:"netUncompressedSizeLabel netSummaryLabel"},"(",u("0KB"),u(" "+s.uncompressed),")"),d({class:"netTimeBar"},u({class:"netTotalTimeLabel netSummaryLabel"},"0ms")))),h({class:"netOptionsCol netCol"})),getIndex:function(e){return e.index+1},getIndent:function(e){return 0},isError:function(e){var t=Math.floor(e.response.status/100);return 4===t||5===t||0===t},isRedirect:function(e){return!1},isFromCache:function(e){return e.cache&&e.cache.afterRequest||i.isCachedEntry(e)},getHref:function(e){var s=t.getFileName(this.getFullHref(e));return unescape(e.request.method+" "+s)},getFullHref:function(e){return unescape(e.request.url)},getStatus:function(e){return 0===e.response.status&&e.response._error?e.response._error:(e.response.status>0?e.response.status+" ":"")+e.response.statusText},getType:function(e){return e.response.content.mimeType},getDomain:function(e){return t.getPrettyDomain(e.request.url)},getServerIPAddress:function(e){return e.serverIPAddress||""},getConnection:function(e){return e.connection||""},getUncompressedSize:function(e){var t=i.getEntryUncompressedSize(e);return this.formatSize(t)},getCompressedSize:function(e){var t=i.getEntryTransferredSize(e);return this.formatSize(t)},isExpandable:function(e){return a.canShowFile(e)},formatSize:function(e){return t.formatSize(e)},getElapsedTime:function(e){var s=Math.round(10*e.time)/10;return t.formatTime(s.toFixed(2))},onClick:function(e){var s=t.fixEvent(e);if(t.isLeftClick(e)){var i=t.getAncestorByClass(s.target,"netRow");i&&(this.toggleHeadersRow(i),t.cancelEvent(e))}else t.isControlClick(e)&&window.open(e.target.innerText||e.target.textContent)},toggleHeadersRow:function(e){if(t.hasClass(e,"isExpandable")){var s,i=e.repObject;if(t.toggleClass(e,"opened"),t.hasClass(e,"opened")){s=this.netInfoTag.insertRows({},e)[0],s.repObject=i;(new a).render(s.firstChild,i)}else s=e.nextSibling,e.parentNode.removeChild(s)}},onOpenOptions:function(e){var s=t.fixEvent(e);if(t.cancelEvent(e),t.isLeftClick(e)){var i=s.target,n=t.getAncestorByClass(i,"netRow"),a=this.getMenuItems(n);if(a.length){new l({id:"requestContextMenu",items:a}).showPopup(i)}}},getMenuItems:function(e){var i=e.repObject,n=e.phase,a=n.files[0]===i&&this.phases[0]===n,r=[{label:s.menuBreakTimeline,type:"checkbox",disabled:a,checked:n.files[0]===i&&!a,command:t.bind(this.breakLayout,this,e)},"-",{label:s.menuOpenRequest,command:t.bind(this.openRequest,this,i)},{label:s.menuOpenResponse,disabled:!i.response.content.text,command:t.bind(this.openResponse,this,i)}];return t.dispatch(this.listeners,"getMenuItems",[r,this.input,i]),r},openRequest:function(e,t){window.open(e.request.url)},openResponse:function(e,t){var s=e.response.content.text,i=e.response.content.mimeType,n=e.response.content.encoding,a="data:"+(i||"")+";"+(n||"")+","+s;window.open(a)},breakLayout:function(e,s){var n=e.repObject,a=e.phase,r=a.files[0]===n;e.breakLayout=!r,e.setAttribute("breakLayout",e.breakLayout?"true":"false");var l=t.getAncestorByClass(e,"netTable"),o=i.getParentPage(this.input,n);this.updateLayout(l,o)},updateLayout:function(e,s){var a=i.getPageEntries(this.input,s);this.table=e;var r=this.table.firstChild,l=this.firstRow=r.firstChild.nextSibling;this.phases=[];var o=n.getCookie("phaseInterval");o||(o=4e3);var c=null,m=s?t.parseISO8601(s.startedDateTime):null,d=s&&s.pageTimings?s.pageTimings.onLoad:-1;d>0&&(d+=m);for(var p=0;p<a.length;p++){var u=a[p];t.hasClass(l,"netInfoRow")&&(l=l.nextSibling),l.repObject=u,m||(m=t.parseISO8601(u.startedDateTime));var f=t.parseISO8601(u.startedDateTime),g=c?t.parseISO8601(c.getLastStartTime()):0,h=c?c.endTime:0,T=!1;o>=0&&(T=f>d&&f-g>=o&&f+u.time>=h+o),"boolean"==typeof l.breakLayout?!c||l.breakLayout?c=this.startPhase(u):c.addFile(u):!c||T?c=this.startPhase(u):c.addFile(u),this.phases[0]!==c&&l.setAttribute("breakLayout",c.files[0]===u?"true":"false"),("number"!=typeof c.startTime||c.startTime>f)&&(c.startTime=f),("number"!=typeof c.endTime||c.endTime<f+u.time)&&(c.endTime=f+u.time),l=l.nextSibling}this.updateTimeStamps(s),this.updateTimeline(s),this.updateSummaries(s)},startPhase:function(e){var t=new c(e);return this.phases.push(t),t},calculateFileTimes:function(e,s,i){if(i!==s.phase&&(i=s.phase,this.phaseStartTime=i.startTime,this.phaseEndTime=i.endTime,this.phaseElapsed=this.phaseEndTime-i.startTime),!s.timings)return i;var n=s.timings.blocked<0?0:s.timings.blocked,a=n+(s.timings.dns<0?0:s.timings.dns),r=a+(s.timings.connect<0?0:s.timings.connect),l=r+(s.timings.send<0?0:s.timings.send),o=l+(s.timings.wait<0?0:s.timings.wait),c=o+(s.timings.receive<0?0:s.timings.receive),m=t.parseISO8601(s.startedDateTime);return this.barOffset=((m-this.phaseStartTime)/this.phaseElapsed*100).toFixed(3),this.barBlockingWidth=(n/this.phaseElapsed*100).toFixed(3),this.barResolvingWidth=(a/this.phaseElapsed*100).toFixed(3),this.barConnectingWidth=(r/this.phaseElapsed*100).toFixed(3),this.barSendingWidth=(l/this.phaseElapsed*100).toFixed(3),this.barWaitingWidth=(o/this.phaseElapsed*100).toFixed(3),this.barReceivingWidth=(c/this.phaseElapsed*100).toFixed(3),this.calculatePageTimings(e,s,i),i},calculatePageTimings:function(e,s,i){if(e)for(var n=t.parseISO8601(e.startedDateTime),a=0;a<i.pageTimings.length;a++){var r=i.pageTimings[a].time;if(r>0){var l=n+r-i.startTime,o=(l/this.phaseElapsed*100).toFixed(3);i.pageTimings[a].offset=o}}},updateTimeline:function(e){for(var s,i=this.firstRow;i;i=i.nextSibling){var n=i.repObject;if(n&&!t.hasClass(i,"netInfoRow")){s=this.calculateFileTimes(e,n,s),i.phase=n.phase,delete n.phase;var a=t.getElementByClass(i,"netTimelineBar"),r=a.children[0],l=r.nextSibling,o=l.nextSibling,c=o.nextSibling,m=c.nextSibling,d=m.nextSibling;r.style.left=o.style.left=l.style.left=c.style.left=m.style.left=d.style.left=this.barOffset+"%",r.style.width=this.barBlockingWidth+"%",l.style.width=this.barResolvingWidth+"%",o.style.width=this.barConnectingWidth+"%",c.style.width=this.barSendingWidth+"%",m.style.width=this.barWaitingWidth+"%",d.style.width=this.barReceivingWidth+"%";for(var p=t.getElementsByClass(a,"netPageTimingBar"),u=0;u<p.length;u++)p[u].parentNode.removeChild(p[u]);for(var f=0;f<s.pageTimings.length;f++){var g=s.pageTimings[f];if(g.offset){var h=a.ownerDocument.createElement("DIV");a.appendChild(h),g.classes&&t.setClass(h,g.classes),t.setClass(h,"netPageTimingBar netBar"),h.style.left=g.offset+"%",h.style.display="block",g.offset=null}}}}},updateTimeStamps:function(e){if(e){var s,i=[],n=this.pageTimings;e.pageTimings&&Object.keys(e.pageTimings).forEach(function(t){var s=e.pageTimings[t];if("number"==typeof s){for(var a={label:t,time:s,classes:"",comment:t},r=0;r<n.length;r++)if(n[r].name===t){a.classes=n[r].classes,a.comment=n[r].comment;break}i.push(a)}});var a=e.pageTimings?e.pageTimings._timeStamps:[];a&&i.push.apply(i,a);var r=this.phases;for(s=0;s<r.length;s++)for(var l=r[s],o=r[s+1],c=0;c<i.length;c++){var m=i[c],d=m.time;if(d){var p=t.parseISO8601(e.startedDateTime);d+=p,(!o||d<o.startTime)&&(0===s||d>=l.startTime)&&(l.startTime>d&&(l.startTime=d),l.endTime<d&&(l.endTime=d),l.pageTimings.push({classes:m.classes?m.classes:"netTimeStampBar",name:m.label,description:m.comment,time:m.time}))}}}},updateSummaries:function(e){for(var s=this.phases,i=0,n=0,a=0,r=0,l=0,o=0;o<s.length;++o){var c=s[o];c.invalidPhase=!1;var m=this.summarizePhase(c);i+=m.fileCount,n+=m.totalTransferredSize,a+=m.totalUncompressedSize,r+=m.cachedSize,l+=m.totalTime}var d=this.summaryRow;if(d){t.getElementByClass(d,"netCountLabel").firstChild.nodeValue=this.formatRequestCount(i);var p=t.getElementByClass(d,"netTotalSizeLabel");p.setAttribute("totalSize",n),p.firstChild.nodeValue=t.formatSize(n);var u=t.getElementByClass(d,"netTotalUncompressedSizeLabel");u.setAttribute("totalUncompressedSize",a),u.firstChild.nodeValue=t.formatSize(a);var f=t.getElementByClass(d,"netUncompressedSizeLabel");f.setAttribute("collapsed",0===a);f.childNodes[1].firstChild.nodeValue=t.formatSize(a);var g=t.getElementByClass(d,"netCacheSizeLabel");g.setAttribute("collapsed",0===r),g.childNodes[1].firstChild.nodeValue=t.formatSize(r);var h=t.getElementByClass(d,"netTotalTimeLabel"),T=t.formatTime(l.toFixed(2));e&&e.pageTimings.onLoad>0&&(T+=" (onload: "+t.formatTime(e.pageTimings.onLoad.toFixed(2))+")"),h.innerHTML=T}},formatRequestCount:function(e){return e+" "+(1===e?s.request:s.requests)},summarizePhase:function(e){for(var s=0,n=0,a=0,r=0,l=0,o=0,c=0;c<e.files.length;c++){var m=e.files[c],d=t.parseISO8601(m.startedDateTime);++r;var p=i.getEntryTransferredSize(m),u=i.getEntryUncompressedSize(m);n+=p,a+=u,i.isCachedEntry(m)&&(s+=u),(!l||d<l)&&(l=d);var f=d+m.time;f>o&&(o=f)}return{cachedSize:s,totalUncompressedSize:a,totalTransferredSize:n,totalTime:o-l,fileCount:r}},showInfoTip:function(e,s,i,n){var a=t.getAncestorByClass(s,"netTable");if(a&&a.repObject===this){var r=t.getAncestorByClass(s,"netRow");if(r){var l;if(t.getAncestorByClass(s,"netBar"))return e.setAttribute("multiline",!0),l=r.repObject.startedDateTime+"-nettime",this.infoTipURL=l,this.populateTimeInfoTip(e,r);if(t.hasClass(s,"netSizeLabel"))return l=r.repObject.startedDateTime+"-netsize",this.infoTipURL=l,this.populateSizeInfoTip(e,r)}}},populateTimeInfoTip:function(e,t){return C.render(this,t,e),!0},populateSizeInfoTip:function(e,t){return b.render(this,t,e),!0},render:function(e,t){var s=i.getPageEntries(this.input,t);return s.length?this.append(e,t,s):null},append:function(e,s,i){this.table||(this.table=this.tableTag.replace({requestList:this},e,this)),this.summaryRow||(this.summaryRow=this.summaryTag.insertRows({},this.table.firstChild)[0]);var n=this.table.firstChild,a=n.lastChild.previousSibling,r=i.map(function(e,s){return t.extend(e,{index:s})}),l=this.fileTag.insertRows({files:r},a,this);return this.updateLayout(this.table,s),l[0]},addPageTiming:function(e){this.pageTimings.push(e)}}),c.prototype={addFile:function(e){this.files.push(e),e.phase=this},getLastStartTime:function(){return this.files[this.files.length-1].startedDateTime}},o});