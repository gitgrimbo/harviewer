/* See license.txt for terms of usage */

define(["../domplate/domplate","i18n!../nls/requestBody","../core/lib","../core/cookies","../domplate/tabView","../domplate/domTree","../core/dragdrop"],function(e,t,n,o,a,s,i){function r(){}function l(e){this.file=e}function c(e){this.file=e}function p(e){this.file=e}function d(e){this.file=e}function f(e){this.file=e}function h(e){this.file=e}function u(e){var n=e.request.method;n=n.charAt(0).toUpperCase()+n.slice(1).toLowerCase(),this.file=e,this.id=n,this.label=t[n]}function m(e){this.file=e}function g(e){this.file=e}function T(e){this.file=e}function y(e){this.file=e}function x(e){this.file=e}function v(e){this.file=e}var I=e.domplate,b=e.A,w=e.CODE,R=e.DIV,H=e.FOR,C=e.IFRAME,q=e.PRE,B=e.TABLE,D=e.TBODY,S=e.TD,E=e.TR;return r.tabTypes=[l,h,u,d,f,x,v,c,p,g,T,y],r.prototype=I({render:function(e,t){var n=new a("requestBody");r.tabTypes.forEach(function(e){e.canShowFile(t)&&n.appendTab(new e(t))});var o=n.render(e);return n.tabs.length>0&&n.selectTabByName(n.tabs[0].id),o}}),r.canShowFile=function(e){return r.tabTypes.some(function(t){return t.canShowFile(e)})},r.canDecode=function(e){return!e||"base64"===e&&"undefined"!=typeof atob},r.decode=function(e,t){return"base64"===t?atob(e):e},l.prototype=I(a.Tab.prototype,{id:"Headers",label:t.Headers,bodyTag:R(R(b({class:"netInfoRequestURL"})),B({class:"netInfoHeadersText netInfoText netInfoHeadersTable",cellpadding:0,cellspacing:0},D(E({class:"netInfoResponseVersionTitle"},S({colspan:2},R({class:"netInfoHeadersGroup"},t.ResponseVersion))),E({class:"netInfoResponseHeadersTitle"},S({colspan:2},R({class:"netInfoHeadersGroup"},t.ResponseHeaders))),E({class:"netInfoRequestVersionTitle"},S({colspan:2},R({class:"netInfoHeadersGroup"},t.RequestVersion))),E({class:"netInfoRequestHeadersTitle"},S({colspan:2},R({class:"netInfoHeadersGroup"},t.RequestHeaders)))))),headerDataTag:H("param","$headers",E(S({class:"netInfoParamName"},"$param.name"),S({class:"netInfoParamValue"},q("$param|getParamValue")))),getParamValue:function(e){return n.wrapText(e.value,!0)},onUpdateBody:function(e,t){var o=this.file.request.url;if(o){var a=$(t).find("a")[0];a.setAttribute("href",o),a.appendChild(document.createTextNode(n.cropString(o,128)))}var s={name:"",value:this.file.response.httpVersion};this.insertHeaderRows(t,[s],"Headers","ResponseVersion"),this.insertHeaderRows(t,this.file.response.headers||[],"Headers","ResponseHeaders");var i={name:"",value:this.file.request.httpVersion};this.insertHeaderRows(t,[i],"Headers","RequestVersion"),this.insertHeaderRows(t,this.file.request.headers||[],"Headers","RequestHeaders")},insertHeaderRows:function(e,t,o,a){var s=n.getElementByClass(e,"netInfo"+o+"Table"),i=n.getElementByClass(s,"netInfo"+a+"Title");t.length?(this.headerDataTag.insertRows({headers:t},i||e),n.removeClass(i,"collapsed")):n.setClass(i,"collapsed")}}),l.canShowFile=function(e){return!0},c.prototype=I(a.Tab.prototype,{id:"Image",label:t.Image,title:t.ImageTitle,bodyTag:R({class:"netInfoImageText netInfoText"}),onUpdateBody:function(e,t){function o(e){return"data:"+n.extractMimeType(e.mimeType)+";base64,"+e.text}var a=n.getElementByClass(t,"netInfoImageText");n.clearNode(a);var s=9===document.documentMode,i=10===document.documentMode;s||i?function(e,t){var n=e.response.content,a=/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/;if(n.text.match(a)){var s=o(n);t.innerHTML="<img src="+s+">"}}(this.file,a):function(e,n){var a=t.ownerDocument.createElement("img"),s=e.response.content;a.src=o(s),n.appendChild(a)}(this.file,a)}}),c.isFileImage=function(e){var t=e.response.content;if(!t)return!1;var o=n.extractMimeType(t.mimeType||"");return n.startsWith(o,"image/")},c.canShowFile=function(e){var t=e.response.content;return c.isFileImage(e)&&t.text&&"base64"===t.encoding},p.prototype=I(a.Tab.prototype,{id:"ExternalImage",label:t.ExternalImage,title:t.ExternalImageTitle,bodyTag:R({class:"netInfoExternalImageText netInfoText"}),onUpdateBody:function(e,t){var o=n.getElementByClass(t,"netInfoExternalImageText");n.clearNode(o);var a=t.ownerDocument.createElement("img");a.src=this.file.request.url,o.appendChild(a)}}),p.canShowFile=function(e){return c.isFileImage(e)},d.prototype=I(a.Tab.prototype,{id:"Response",label:t.Response,bodyTag:R({class:"netInfoResponseText netInfoText"},q()),onUpdateBody:function(e,t){var o=n.getElementByClass(t,"netInfoResponseText"),a=o.firstChild;n.clearNode(a);var s=this.file.response.content.text;n.insertWrappedText(s,a)}}),d.canShowFile=function(e){return e.response.content.text&&e.response.content.text.length>0},f.prototype=I(a.Tab.prototype,{id:"Highlighted",label:t.Highlighted,bodyTag:R({class:"netInfoHighlightedText netInfoText"},q(w("class","javascript"))),onUpdateBody:function(e,t){var o=n.getElementByClass(t,"netInfoHighlightedText"),a=o.firstChild.firstChild;n.clearNode(a);var s=this.file.response.content,i=s.text,l=n.extractMimeType(s.mimeType),c=f.shouldHighlightAs(l);if(c){a.className=c,i=r.decode(i,s.encoding),a.appendChild(document.createTextNode(i)),hljs.highlightBlock(a);var p=a;a.classList.contains("hljs")&&p.setAttribute("highlighted",!0)}else n.insertWrappedText(i,pre)}}),f.canShowFile=function(e){var t=e.response.content;if(!t||!t.text)return!1;if(!r.canDecode(t.encoding))return!1;var o=n.extractMimeType(t.mimeType||"");return null!==f.shouldHighlightAs(o)},f.shouldHighlightAs=function(e){var t={javascript:["application/javascript","text/javascript","application/x-javascript","text/ecmascript","application/ecmascript","application/json"],css:["text/css"],html:["text/html","application/xhtml+xml"]};for(var n in t)if(t[n].indexOf(e)>-1)return n;return v.isXmlMimeType(e)?"xml":null},h.prototype=I(l.prototype,{id:"Params",label:t.URLParameters,bodyTag:B({class:"netInfoParamsText netInfoText netInfoParamsTable",cellpadding:0,cellspacing:0},D()),onUpdateBody:function(e,t){if(this.file.request.queryString){var o=n.getElementByClass(t,"netInfoParamsText");this.insertHeaderRows(o,this.file.request.queryString,"Params")}}}),h.canShowFile=function(e){return e.request.queryString&&e.request.queryString.length},u.prototype=I(l.prototype,{bodyTag:R({class:"netInfo$tab.id\\Text netInfoText"},B({class:"netInfo$tab.id\\Table",cellpadding:0,cellspacing:0},D())),onUpdateBody:function(e,t){var o=this.file.request.postData;if(o){var a=n.getElementByClass(t,"netInfo"+this.id+"Text");"application/x-www-form-urlencoded"===o.mimeType?this.insertHeaderRows(a,o.params,this.id):n.insertWrappedText(o.text,a)}}}),u.canShowFile=function(e){var t=e.request.postData;if(!t)return!1;var o=!n.isArray(t.params)||0===t.params.length,a=!t.text;return!(o&&a)||["PUT","POST"].indexOf(e.request.method)>-1},m.prototype=I(l.prototype,{id:"Cookies",label:t.Cookies,bodyTag:R({class:"netInfoCookiesText netInfoText"},B({class:"netInfoCookiesTable",cellpadding:0,cellspacing:0},D(E({class:"netInfoResponseCookiesTitle"},S({colspan:2},R({class:"netInfoCookiesGroup"},t.ResponseCookies))),E({class:"netInfoRequestCookiesTitle"},S({colspan:2},R({class:"netInfoCookiesGroup"},t.RequestCookies)))))),onUpdateBody:function(e,t){var o=n.getElementByClass(t,"netInfoParamsText"),a=this.file;a.response.cookies&&this.insertHeaderRows(o,a.response.cookies,"Cookies","ResponseCookies"),a.request.cookies&&this.insertHeaderRows(o,a.request.cookies,"Cookies","RequestCookies")}}),g.prototype=I(l.prototype,{id:"Cache",label:t.Cache,bodyTag:R({class:"netInfoCacheText netInfoText"},B({class:"netInfoCacheTable",cellpadding:0,cellspacing:0},D())),onUpdateBody:function(e,t){if(this.file.cache&&this.file.cache.afterRequest){var n=this.file.cache.afterRequest,o=[];for(var a in n)o.push({name:a,value:n[a]});this.insertHeaderRows(t,o,"Cache")}}}),g.canShowFile=function(e){return!!e.cache&&!!e.cache.afterRequest},T.prototype=I(l.prototype,{id:"HTML",label:t.HTML,bodyTag:R({class:"netInfoHtmlText netInfoText"},C({class:"netInfoHtmlPreview",onload:"$onLoad"}),R({class:"htmlPreviewResizer"})),onUpdateBody:function(e,t){this.preview=n.getElementByClass(t,"netInfoHtmlPreview");var a=parseInt(o.getCookie("htmlPreviewHeight"),10);isNaN(a)||(this.preview.style.height=a+"px");var s=n.getElementByClass(t,"htmlPreviewResizer");this.resizer=new i.Tracker(s,{onDragStart:n.bind(this.onDragStart,this),onDragOver:n.bind(this.onDragOver,this),onDrop:n.bind(this.onDrop,this)})},onLoad:function(e){var t=n.fixEvent(e),o=n.getAncestorByClass(t.target,"tabHTMLBody").repObject;o.preview.contentWindow.document.body.innerHTML=o.file.response.content.text},onDragStart:function(e){n.getBody(this.preview.ownerDocument).setAttribute("hResizing","true"),this.startHeight=this.preview.clientHeight},onDragOver:function(e,t){var n=this.startHeight+e.y;this.preview.style.height=n+"px",o.setCookie("htmlPreviewHeight",n)},onDrop:function(e){n.getBody(this.preview.ownerDocument).removeAttribute("hResizing")}}),T.canShowFile=function(e){var t=e.response.content.mimeType||"",o=e.mimeType||"";return n.startsWith(t,"text/html")||n.startsWith(o,"application/xhtml+xml")},y.prototype=I(l.prototype,{id:"DataURL",label:t.DataURL,bodyTag:R({class:"netInfoDataURLText netInfoText"}),onUpdateBody:function(e,t){var o=n.getElementByClass(t,"netInfoDataURLText"),a=this.file.request.url;if(0===a.indexOf("data:image")){var s=t.ownerDocument.createElement("img");s.src=a,o.appendChild(s)}else n.insertWrappedText(unescape(a),o)}}),y.canShowFile=function(e){return 0===e.request.url.indexOf("data:")},x.prototype=I(a.Tab.prototype,{id:"JSON",label:t.JSON,bodyTag:R({class:"netInfoJsonText netInfoText"}),onUpdateBody:function(e,t){n.clearNode(t.firstChild);var o=this.file.response.content;try{var a=r.decode(o.text,o.encoding),i=JSON.parse(a);new s(i).append(t)}catch(e){t.innerHTML=String(e)}}}),x.canShowFile=function(e){var t=e.response.content;return!(!t||!t.text)&&(!!r.canDecode(t.encoding)&&["application/json"].indexOf(n.extractMimeType(t.mimeType||""))>-1)},v.prototype=I(a.Tab.prototype,{id:"XML",label:t.XML,bodyTag:R({class:"netInfoXmlText netInfoText"}),onUpdateBody:function(e,t){n.clearNode(t.firstChild);var o=this.file.response.content;try{var a=r.decode(o.text,o.encoding),i=$.parseXML(a);new s(i).append(t)}catch(e){t.innerHTML=String(e)}}}),v.isXmlMimeType=function(e){return e=n.extractMimeType(e),["text/xml","application/xml","image/svg+xml","application/atom+xml","application/xslt+xml","application/mathml+xml","application/rss+xml"].indexOf(e)>-1},v.canShowFile=function(e){var t=e.response.content;if(!t||!t.text)return!1;if(!r.canDecode(t.encoding))return!1;var o=n.extractMimeType(t.mimeType||"");return v.isXmlMimeType(o)},r});