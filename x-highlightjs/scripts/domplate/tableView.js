/* See license.txt for terms of usage */

define(["./domplate","../core/lib","i18n!../nls/tableView","./domTree","../core/trace"],function(e,t,a,r,o){var l=e.domplate,s=e.DIV,n=e.FOR,i=e.TABLE,d=e.TAG,c=e.TBODY,u=e.TD,h=e.TH,p=e.THEAD,g=e.TR;return l({className:"table",tag:s({class:"dataTableSizer",tabindex:"-1"},i({class:"dataTable",cellspacing:0,cellpadding:0,width:"100%",role:"grid"},p({class:"dataTableThead",role:"presentation"},g({class:"headerRow focusRow dataTableRow subFocusRow",role:"row",onclick:"$onClickHeader"},n("column","$object.columns",h({class:"headerCell a11yFocus",role:"columnheader",$alphaValue:"$column.alphaValue"},s({class:"headerCellBox"},"$column.label"))))),c({class:"dataTableTbody",role:"presentation"},n("row","$object.data|getRows",g({class:"focusRow dataTableRow subFocusRow",role:"row"},n("column","$row|getColumns",u({class:"a11yFocus dataTableCell",role:"gridcell"},d("$column|getValueTag",{object:"$column"})))))))),getValueTag:function(e){if("object"==typeof e)return r.Reps.Tree.tag;var t=r.Reps.getRep(e);return t.shortTag||t.tag},getRows:function(e){var t=this.getProps(e);return t.length?t:[]},getColumns:function(e){if("object"!=typeof e)return[e];for(var t=[],a=0;a<this.columns.length;a++){var r,o=this.columns[a].property;if(o)if(void 0===e[o]){var l="string"==typeof o?o.split("."):[o];r=e;for(var s in l)r=r&&r[l[s]]||void 0}else r=e[o];else r=e;t.push(r)}return t},getProps:function(e){if("object"!=typeof e)return[e];if(e.length)return t.cloneArray(e);var a=[];for(var r in e){var o=e[r];this.domFilter(o,r)&&a.push(o)}return a},onClickHeader:function(e){var a=t.getAncestorByClass(e.target,"dataTable"),r=t.getAncestorByClass(e.target,"headerCell");if(r){var o=!t.hasClass(r,"alphaValue"),l=0;for(r=r.previousSibling;r;r=r.previousSibling)++l;this.sort(a,l,o)}},sort:function(e,a,r){for(var o=t.getChildByClass(e,"dataTableTbody"),l=t.getChildByClass(e,"dataTableThead"),s=[],n=o.childNodes[0];n;n=n.nextSibling){var i=n.childNodes[a],d=r?parseFloat(i.textContent):i.textContent;s.push({row:n,value:d})}s.sort(function(e,t){return e.value<t.value?-1:1});var c=l.firstChild,u=t.getChildByClass(c,"headerSorted");t.removeClass(u,"headerSorted"),u&&u.removeAttribute("aria-sort");var h=c.childNodes[a];if(t.setClass(h,"headerSorted"),h.sorted&&1!==h.sorted){t.removeClass(h,"sortedAscending"),t.setClass(h,"sortedDescending"),h.setAttribute("aria-sort","descending"),h.sorted=1;for(var p=s.length-1;p>=0;--p)o.appendChild(s[p].row)}else{t.removeClass(h,"sortedDescending"),t.setClass(h,"sortedAscending"),h.setAttribute("aria-sort","ascending"),h.sorted=-1;for(var g=0;g<s.length;++g)o.appendChild(s[g].row)}},getHeaderColumns:function(e){var t;for(var r in e){t=e[r];break}if("object"!=typeof t)return[{label:a.objectProperties}];var o=[];for(var l in t){var s=t[l];this.domFilter(s,l)&&o.push({property:l,label:l,alphaValue:"number"!=typeof s})}return o},domFilter:function(e,t){return!0},render:function(e,a,r){if(a){for(var l=[],s=0;r&&s<r.length;s++){var n=r[s],i=void 0!==n.property?n.property:n,d=void 0!==n.label?n.label:i;l.push({property:i,label:d,alphaValue:!0})}l.length||(l=this.getHeaderColumns(a));try{this.columns=l;var c={data:a,columns:l},u=this.tag.append({object:c,columns:l},e),h=t.getElementByClass(u,"dataTableTbody");h.clientHeight>200&&(h.style.height="200px")}catch(e){o.exception("tableView.render; EXCEPTION "+e,e)}finally{delete this.columns}}}})});